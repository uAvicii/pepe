<!doctype html>
<html lang="en">
  <head>
    <title>three.js webaudio - timing</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
    <link type="text/css" rel="stylesheet" href="main.css" />
  </head>
  <body>
    <div id="overlay">
      <button id="startButton">Play</button>
    </div>
    <div id="container"></div>
    <!-- <div id="info">
      <a href="https://threejs.org" target="_blank" rel="noopener noreferrer">three.js</a> webaudio
      - timing<br />
      sound effect by
      <a
        href="https://freesound.org/people/michorvath/sounds/269718/"
        target="_blank"
        rel="noopener noreferrer"
        >michorvath</a
      >
    </div> -->

    <!-- Import maps polyfill -->
    <!-- Remove this when import maps will be widely supported -->
    <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>

    <script type="importmap">
      {
        "imports": {
          "three": "./three.module.js",
          "three/addons/": "./jsm/"
        }
      }
    </script>

    <script type="module">
      import * as THREE from 'three'

      import { OrbitControls } from 'three/addons/controls/OrbitControls.js'

      let scene, camera, renderer, clock

      const objects = []

      const speed = 1 // 速度
      const height = 3 // 高度
      const offset = 0.5 // 偏移量

      const startButton = document.getElementById('startButton')
      startButton.addEventListener('click', init)
      let floor
      function init() {
        const overlay = document.getElementById('overlay') // 覆盖层
        overlay.remove() // 移除覆盖层

        const container = document.getElementById('container') // 容器

        scene = new THREE.Scene() // 场景

        clock = new THREE.Clock() // 时钟

        //

        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100) // 相机 透视相机
        camera.position.set(10, 5, 10) // 相机位置

        // lights

        const ambientLight = new THREE.AmbientLight('#fff') // 环境光
        scene.add(ambientLight) // 添加到场景

        const directionalLight = new THREE.DirectionalLight('orange', 2.5) // 平行光
        directionalLight.position.set(0, 5, 5) // 平行光位置
        scene.add(directionalLight) // 添加到场景

        const d = 5 // 距离
        directionalLight.castShadow = true // 投影
        directionalLight.shadow.camera.left = -d // 投影相机
        directionalLight.shadow.camera.right = d // 投影相机
        directionalLight.shadow.camera.top = d // 投影相机
        directionalLight.shadow.camera.bottom = -d // 投影相机 近平面和远平面

        directionalLight.shadow.camera.near = 1 // 投影相机 近平面
        directionalLight.shadow.camera.far = 20 // 投影相机 远平面

        directionalLight.shadow.mapSize.x = 1024 // 投影贴图大小
        directionalLight.shadow.mapSize.y = 1024 // 投影贴图大小

        // audio

        const audioLoader = new THREE.AudioLoader() // 音频加载器

        const listener = new THREE.AudioListener() // 音频监听器
        camera.add(listener) // 相机添加监听器

        // floor

        const floorGeometry = new THREE.PlaneGeometry(10, 10) // 地板几何体
        const floorMaterial = new THREE.MeshLambertMaterial({ color: 0x4676b6 }) // 地板材质

        floor = new THREE.Mesh(floorGeometry, floorMaterial) // 地板 网格
        floor.rotation.x = Math.PI * -0.5 // 地板旋转
        floor.rotation.z = 0.01
        floor.receiveShadow = true // 接收阴影
        scene.add(floor) // 场景添加地板

        // objects

        const count = 15 // 数量
        const radius = 3 // 半径

        const ballGeometry = new THREE.SphereGeometry(0.3, 32, 16) // 球体几何体
        ballGeometry.translate(0, 0.3, 0) // 球体几何体平移
        const ballMaterial = new THREE.MeshLambertMaterial({ color: 'purple' }) // 球体材质

        // create objects when audio buffer is loaded

        audioLoader.load('sounds/ping_pong.mp3', function (buffer) {
          // 加载音频
          for (let i = 0; i < count; i++) {
            // 循环创建
            const s = (i / count) * Math.PI * 2 // 角度

            const ball = new THREE.Mesh(ballGeometry, ballMaterial) // 球体 网格
            ball.castShadow = true // 投影
            ball.userData.down = false // 下降

            ball.position.x = radius * Math.cos(s) // 球体位置
            ball.position.z = radius * Math.sin(s) // 球体位置

            const audio = new THREE.PositionalAudio(listener) // 位置音频
            audio.setBuffer(buffer) // 设置音频缓冲
            ball.add(audio) // 球体添加音频

            scene.add(ball) // 场景添加球体
            objects.push(ball) // 添加到数组
          }

          animate() // 动画
        })

        //

        renderer = new THREE.WebGLRenderer({ antialias: true }) // 渲染器
        renderer.setPixelRatio(window.devicePixelRatio) // 设置像素比
        renderer.setSize(window.innerWidth, window.innerHeight) // 设置渲染器大小
        renderer.shadowMap.enabled = true // 阴影
        container.appendChild(renderer.domElement) // 容器添加渲染器dom元素

        //

        const controls = new OrbitControls(camera, renderer.domElement) // 轨道控制器
        controls.minDistance = 1 // 最小距离
        controls.maxDistance = 25 // 最大距离

        //

        window.addEventListener('resize', onWindowResize) // 窗口大小改变事件
      }

      function onWindowResize() {
        // 窗口大小改变
        camera.aspect = window.innerWidth / window.innerHeight // 相机长宽比
        camera.updateProjectionMatrix() // 更新相机投影矩阵

        renderer.setSize(window.innerWidth, window.innerHeight) // 设置渲染器大小
      }

      function animate() {
        // 动画
        requestAnimationFrame(animate) // 动画
        let x = 0.01 * floor.rotation.z
        floor.rotation.z += x
        console.log(floor.rotation.z);
        render() // 渲染
      }

      function render() {
        const time = clock.getElapsedTime() // 获取时间

        for (let i = 0; i < objects.length; i++) {
          // 循环
          const ball = objects[i] // 球体

          const previousHeight = ball.position.y // 上一个高度
          ball.position.y = Math.abs(Math.sin(i * offset + time * speed) * height) // 球体位置

          if (ball.position.y < previousHeight) {
            // 下降
            ball.userData.down = true // 下降
          } else {
            // 上升
            if (ball.userData.down === true) {
              // ball changed direction from down to up

              const audio = ball.children[0] // 音频 位置音频
              audio.play() // play audio with perfect timing when ball hits the surface
              ball.userData.down = false // 上升
            }
          }
        }

        renderer.render(scene, camera) // 渲染 场景 相机
      }
    </script>
  </body>
</html>
